% this function runs the reaction ... Mac versionfunction[AllTimes] = MovieRTTimeclose all           % closes any open matlab figure windows: just a bit of house-keeping% change this bit to change where the data files are heldDataFilesFolder = ['Macintosh HD:Desktop Folder:PsychToolbox:RVIPFiles:RVIPData'];% change this bit to change where the movie files are heldClipsFolder = ['Macintosh HD:Desktop Folder:Experiments:Library Ex5:Andy'];% these bits define the default values for the parameters which are under% user-controlNumClips=42;             % Number of clips being shownHotClips = [20 42];     % Which clips are 'hot'NumQuestionsAsked = 5;  % how many questions to ask in the loaded testRandomQus = 0;          % Whether or not questions are asked in a random order: 1= random, 0 = non-random;QuestionOrder = [1:NumQuestionsAsked];  % if questions not random, order that questions are asked in.                                        % Here it is set as sequential ie [1, 2, .. NumQuestionsAsked]StartGap = 1;           % time (in secs) between movie and questions                                       LengthQus = 8;          % time (in secs) for questions to be asked for memory testEndGap = 5;          % time (in secs) between end of questions and next movie                                       ReactThresh = 0.25;     % Reaction threshold in seconds: reactions within this time are discounted% This bit opens a window and references it as 'window'. All functions% which draw/show stuff will reference 'window' when telling functions% where to draw or showscreenNumber = 0;       [DrawingWin,screenRect] = SCREEN(screenNumber,'OpenWindow',WhiteIndex(0));% these bits define the colours matlab uses to draw with the SCREEN% function. Not to be worried aboutwhite=WhiteIndex(DrawingWin);black=BlackIndex(DrawingWin);gray=GrayIndex(DrawingWin,0.5);% Set up some text for user interface. SCREEN(DrawingWin,'TextFont','Times New Roman');    % Change this bit if you don't like the fontSCREEN(DrawingWin,'TextSize',24);   % Change this bit if you don't like the font sizeCarryOn=1;        % this is an internal flag which says whether to go round the main while loop or not  AllYes=[];AllNos=[];AllMids=[];AllTimes=[];WaitSecs(0.01);while(CarryOn==1)       % while CarryOn = 1, the program carry's on going round the while loop     HideCursor;         % this command hides the cursor        % the following write black text at the positions indicated    SCREEN(DrawingWin,'DrawText','1. Run test 1',300,250,black);    SCREEN(DrawingWin,'DrawText','2. Run test 2',300,300,black);    SCREEN(DrawingWin,'DrawText','3. Change parameters',300,350,black);    SCREEN(DrawingWin,'DrawText','4. Quit',300,400,black);        % This asks for a number, stores it, then deletes the question     number = GetEchoNumber(DrawingWin,'Enter a number (followed by Enter or Return):',300,450,black,white);    Screen(DrawingWin,'FillRect',white);	% this fills the screen with white so that the text is deleted        if((number ==1)|(number==2))          % if 1 has been entered run the test with memory load                % this asks for and stores a filename for the data file        fstr = GetEchoString(DrawingWin,'Enter filename:',300,400,black,white);        OutFile=[fstr  '.dat'];                   SubjectData(1) = GetEchoNumber(DrawingWin,'Enter subject number:',300,400,black,white);        SubjectData(2) = GetEchoNumber(DrawingWin,'Enter subject''s age:',300,400,black,white);        SubjectData(3) = GetEchoNumber(DrawingWin,'Enter NART score:',300,400,black,white);        SubjectData(4) = GetEchoNumber(DrawingWin,'Enter memory test score:',300,400,black,white);        SubjectData(5) = GetEchoNumber(DrawingWin,'Enter subject''s gender (0 = male, 1 = female):',300,400,black,white);                % this is the memory load. It = 1 if test 1 selected as it is the        % one with memory load, 0 if test 2 selected        if(number==1) SubjectData(6) = 1;          else SubjectData(6) = 2;        end                SubjectData(7) = GetEchoNumber(DrawingWin,'Enter familiarity (0 = familiar, 1 = unfamiliar):',300,400,black,white);                % more text written               WaitSecs(0.001);    % just so function is in memory		randperm(10);		% same as		Screen(DrawingWin,'FillRect',white);		ts(1)=getsecs;				cd(ClipsFolder);		AllMids=[];        for ClipNum=1:NumClips            %			Screen(DrawingWin,'FillRect',gray);			            if(ismember(ClipNum,HotClips))            	filename = ['Macintosh HD:Desktop Folder:Experiments:Library Ex5:Andy:Clip' int2str(ClipNum) 'TARGET.mov'];            else            	filename = ['Macintosh HD:Desktop Folder:Experiments:Library Ex5:Andy:Clip' int2str(ClipNum) '.mov'];            end					isfile(filename)            [yes,nos,mids,StartT,ttimes]=RunMovieTest2(DrawingWin,filename,StartGap,EndGap,getsecs,ReactThresh);			TargetTimes(ClipNum,:)=ttimes;			if(isempty(mids)) AllMids=[AllMids -1];			else AllMids=[AllMids mids-StartT  -1];			end	            MovieStarts(ClipNum)=StartT;            ts(ClipNum+1)=getsecs;        end		        SCREEN(DrawingWin,'TextSize',24);        Ask(DrawingWin,'Finished! Call tester',black,white,'GetNumber');        HideCursor;        				cd(DataFilesFolder)    % change to folder containing data files        OutputData(AllMids,MovieStarts,SubjectData,OutFile,ReactThresh,HotClips,TargetTimes);                    elseif(number == 3)     % if 3 entered change parameters        ChangeParams = 1;    % this controls whether parameters are changed or not        while(ChangeParams)  % use a while loop to change parameters so that they can be re-entered etc            % print current parameters            SCREEN(DrawingWin,'DrawText','Current parameters are:',300,200,black);              SCREEN(DrawingWin,'DrawText',['1. Number of clips shown = ' int2str(NumClips)],300,250,black);            SCREEN(DrawingWin,'DrawText',['2. Hot clips are numbers ' int2str(HotClips)],300,300,black);            SCREEN(DrawingWin,'DrawText',['3. Number of questions asked = ' int2str(NumQuestionsAsked)],300,350,black);            % see if questions asked randomly or not            if(RandomQus) SCREEN(DrawingWin,'DrawText',['4. Questions asked in a random order'],300,400,black);              else SCREEN(DrawingWin,'DrawText',['4. Order of questions fixed. Order is:' int2str(QuestionOrder)],300,400,black);             end					SCREEN(DrawingWin,'DrawText',['5. Length of reaction latency = ' num2str(ReactThresh)],300,450,black);            % ask which parameter to change and then change it            % ****WARNING*** I haven't checked to ensure all parameters are sensible so             % if a strange parameter is entered it may the program may crash            ParamToChange = GetEchoNumber(DrawingWin,'Enter number of parameter to change. Enter 0 to quit',300,550,black,white);                        if(ParamToChange==1)  % Change number of clips. Keeps asking for number till its > 0                NumClips=0;                while(NumClips<=0) NumClips = GetEchoNumber(DrawingWin,'Enter number of clips to show (>0)',300,550,black,white); end;                            elseif(ParamToChange==2)  % Change the 'hot' clips                HotClips = GetEchoNumber(DrawingWin,'Enter the number of the hot clips separated by a space',300,550,black,white);                             elseif(ParamToChange==3)  % Change number of questions. Keeps asking for number till its > 0                NumQuestionsAsked=0;                while(NumQuestionsAsked<=0) NumQuestionsAsked = min(5,GetEchoNumber(DrawingWin,'Enter number of questions to ask (1-5)',300,550,black,white)); end;                            elseif(ParamToChange==4)  % Change randomness or not of question order                YesStr = GetEchoString(DrawingWin,'Questions asked in random order? (y/n)',300,550,black,white);                if((YesStr=='y')|(YesStr=='Y')) RandomQus = 1;                else                  % if order fixed, enter question order. Will continue to ask until order is number of questions long                    RandomQus = 0;                    QuestionOrder=[];                    while(length(QuestionOrder)~=NumQuestionsAsked)                        QuestionOrder = GetEchoNumber(DrawingWin,'Enter the order of questions (1-5) separated by a space',300,550,black,white)                    end;                    % Make sure the order of questions is between 1 and 5                     QuestionOrder=min(5,max(1,QuestionOrder))                    s=['4. Order of questions fixed. Order is:' int2str(QuestionOrder)]                end            elseif(ParamToChange==5)  % Change reaction latency. Keeps asking till its > 0                ReactThresh=-1;                while(ReactThresh<0) ReactThresh = min(5,GetEchoNumber(DrawingWin,'Enter length of reaction latency (s)',300,550,black,white)); end;                                          elseif(ParamToChange==0)  % Quit change parameters                ChangeParams=0;            end            Screen(DrawingWin,'FillRect',white);	%  fills the screen with white so text is deleted                  end    else            % if any number other than 1 or 2 selected        CarryOn=0;  % CarryOn is set to 0 and we exit the while loop     endendShowCursor;                   % Show the cursor and SCREEN(DrawingWin,'Close');       % close the screen% Function which actually runs the movie and does the rttest etcfunction[yes,nos,mids,TStart,TargetTimes] = RunMovieTest2(DrawingWin,filename,StartGap,EndGap,tnow,ReactThresh)ts=getsecs;white=WhiteIndex(DrawingWin);black=BlackIndex(DrawingWin);port=psychserial('open', '.Bin', '.BOut', 19200);SCREEN(DrawingWin,'TextSize',36);SCREEN(DrawingWin,'TextFont','Times New Roman');SCREEN(DrawingWin,'DrawText',['Press button box to continue'],300,300,black);a= psychserial('read', port, 0.001);while(~isempty(a))	a= psychserial('read', port, 0.001);endwhile(isempty(a))	a= psychserial('read', port, 0.001);endScreen(DrawingWin,'FillRect',white);SCREEN(DrawingWin,'DrawText',['Get ready for next movie'],300,300,black);% show the moviemovie=Showtime('GetFromFile',filename);Showtime('LoadIntoRam',movie);Showtime('Window',movie,DrawingWin);a= psychserial('read', port, 0.001);while(~isempty(a))    a= psychserial('read', port, 0.001);endprems=[];%frate=showtime('Rate',movie);tbetweenframes=0.04;%1/frate;nos=[];yes=[];mids=[];if((getsecs-tnow)<EndGap) 	WaitSecs(EndGap-getsecs+tnow);end;Screen(DrawingWin,'FillRect',white);TStart=getsecs;%t=TStart;for i=1:250         t=getsecs;    Showtime('MovieFrameDisplay',movie,i);    loop={	'prems=[prems getsecs];'	'while((getsecs-t)<tbetweenframes);'         'a = uint8(psychserial(''read'', port,0.0001));'        'if(~isempty(a));'            'if(sum(a)==4);'                 'yes=[yes getsecs];'            'elseif(sum(a)==1);'                 'nos=[nos getsecs];'            'end;'            'if(sum(a)==2);'                 'mids=[mids getsecs];'            'end;'        'end;'    'end;'	};	RUSH(loop,1);	%t=t+tbetweenframes;endtend=getsecs;Screen(DrawingWin,'FillRect',white);Showtime('Dispose',movie);psychserial('close', port);%yes-prems(1);%noos=nos-prems(1);%midl=mids-prems(1);%tlen=tend-prems(1);%tlenall=getsecs-TStart%Mstart=prems-TStart;TStart=prems(1);TargetTimes=prems([1:50:201])-TStart;function OutputData(PCopyPress,MovieStarts,SubjectData,OutFile,ReactThresh,HotClips,TargetTimes)fid=fopen(OutFile,'a');for i=1:length(SubjectData) fprintf(fid,'%d \t ',SubjectData(i)); end;j=1;for i=1:length(MovieStarts)	fprintf(fid,'Clip %d\t',i);		while(PCopyPress(j)~=-1)		if(PCopyPress(j)>ReactThresh) 			fprintf(fid,'%1.4f\t',PCopyPress(j));		end		j=j+1;	end	j=j+1;endfprintf(fid,'\n'); fclose(fid);